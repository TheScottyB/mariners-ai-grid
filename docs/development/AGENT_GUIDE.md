# AI Agent Development Guide

**For Claude Code, Gemini Conductor, and Warp Agent**

This document provides instructions for AI agents working on the Mariner's AI Grid project. All agents operate in a **secure local development environment** on macOS with full local file system, bash command, and web access.

---

## Project Overview: The "Maverick" Architecture

**Mariner's AI Grid (MAG)** is an offline-first, agentic weather platform built for deep-water navigation. It rejects the "Cloud-First" orthodoxy, treating the vessel as a sovereign compute node.

### Core Philosophy: "Sovereign AI"
The boat must be able to predict weather, detect hazards, and search historical patterns without any satellite connection.

### The "Circular Truth" Loop
1. **Slicer (Cloud):** Compresses 10GB global models into <5MB regional "Seeds"
2. **Seed (Transport):** Delivers high-res data via minimal satellite bandwidth (Parquet/Protobuf)
3. **Inference (Boat):** Runs GraphCast AI locally on the NPU
4. **Bridge (Truth):** Validates AI against real-time NMEA 2000 sensors

---

## CNG-Only Architecture (Critical)

This project uses **Continuous Native Generation (CNG)**. Native code is auto-generated - agents should NEVER manually edit it.

### Files Agents CAN Edit (Safe)
```
app.json / app.config.js    - Expo configuration
package.json                 - Dependencies and op-sqlite config
src/**/*.ts                  - TypeScript source files
*.md                         - Documentation
```

### Files Agents Must NEVER Edit (Auto-Generated)
```
ios/                         - Generated by `npx expo prebuild`
android/                     - Generated by `npx expo prebuild`
modules/                     - Should NOT exist (use op-sqlite config)
plugins/                     - Should NOT exist (CNG handles this)
```

### Approved Config Plugins
```
plugins/withMarinerOptimizations.ts  - Zero Latency Apple Silicon optimizations
```
**Note:** This plugin injects compiler flags (-O3, -ffast-math, -mfpu=neon) into op-sqlite builds. Agents may edit this plugin to tune optimization flags, but should NOT create new native module plugins.

---

## Vector DB Configuration

All sqlite-vec native compilation is handled automatically by op-sqlite:

```json
// package.json - This is the ONLY configuration needed
{
  "op-sqlite": {
    "sqliteVec": true
  }
}
```

**DO NOT create custom Config Plugins or native modules for sqlite-vec.**

> See [../architecture/VECTOR_DB_DECISION.md](../architecture/VECTOR_DB_DECISION.md) for full technical rationale.

---

## Directory Map

| Path | Purpose | Key Files |
|:-----|:--------|:----------|
| **`conductor/`** | Python Backend & Slicer | `slicer/aifs.py`, `slicer/variables.py` |
| **`src/services/`** | Core Business Logic | `VecDB.ts`, `MarinerInference.ts`, `SignalKBridge.ts` |
| **`src/components/`** | UI Components | `PatternAlert.tsx`, `MarinerMap.tsx` |
| **`scripts/`** | Automation | `deploy_fleet.sh`, `SeedUploader.ts` |
| **`docs/`** | Documentation | Architecture, development, and release docs |

---

## Key Logic & "Secret Sauce"

### 1. The Hybrid Query (`VecDB.ts`)
Combines **Geospatial Filtering** with **Vector Similarity**:
```sql
SELECT ... FROM atmospheric_patterns
WHERE lat BETWEEN ? AND ?  -- Phase 1: Fast Geo Filter
AND vec_distance_cosine(...) < ? -- Phase 2: Vector Search
```
Enables "Vibe Search" ("Show me storms like this one nearby") without scanning the entire global database.

### 2. The Pacific Seed Audit (`conductor/slicer/`)
Quantization strategy perfectly tuned for maritime use:
- **Wind:** 0.5kt precision (15% compression gain)
- **Direction:** 5 precision (20% compression gain)
- **Result:** 10GB Global GRIB -> **2.1 MB** Regional Seed

### 3. Open Data Advantage
Leverages the Oct 1, 2025 ECMWF Open Data transition:
- **IFS HRES:** Native 9km resolution physics-based baseline
- **AIFS:** 28km resolution AI-driven model for global trends
- **AIFS-ENS:** Ensemble AI for probabilistic risk assessment
- **Fallback:** If `00Z` run is missing, auto-falls back to `12Z`

---

## Environment Variables

### Critical Rules
- **NEVER replace existing API keys with placeholders**
- **NEVER add placeholder text like `your_token_here` where real keys exist**
- **NEVER request keys that are already present**
- If you need to reference a key, read it from the environment - DO NOT modify the file

### Safe Operations
```bash
# Read existing keys (ALLOWED)
source .env
echo "Using Mapbox token: ${EXPO_PUBLIC_MAPBOX_TOKEN:0:10}..."

# Use keys in commands without exposing them (ALLOWED)
export MAPBOX_TOKEN=$(grep EXPO_PUBLIC_MAPBOX_TOKEN .env | cut -d '=' -f2)
```

### Unsafe Operations
```bash
# NEVER DO THIS - destroys real keys
sed -i 's/pk\.ey.*/pk.YOUR_TOKEN_HERE/' .env

# NEVER DO THIS - loses tracking of what keys exist
echo "EXPO_PUBLIC_MAPBOX_TOKEN=your_token_here" > .env
```

### Required Keys (Only These Two)
1. `EXPO_PUBLIC_MAPBOX_TOKEN` - Public Mapbox token for map rendering
2. `RNMAPBOX_MAPS_DOWNLOAD_TOKEN` - Secret token for iOS/Android builds

### Keys That Should NEVER Be Added
- `ANTHROPIC_API_KEY` - Not used (local inference only)
- `OPENAI_API_KEY` - Not used (local inference only)
- `GEMINI_API_KEY` - Not used (local inference only)
- Any other AI service keys

---

## Common Workflows

### Running the Slicer (Backend)
```bash
cd conductor
uv run mag-slicer slice --lat 34.0 --lon -119.0 --radius 100 --hours 24 --offline
```
*Use `--offline` for mock data generation if live ECMWF data is unavailable.*

### Building the Fleet (Mobile)
```bash
# Requires EXPO_PUBLIC_MAPBOX_TOKEN
./scripts/deploy_fleet.sh
```
*Select option 2 for "Foundation Fleet" (Ad Hoc build).*

### Mobile Development
```bash
npx expo start
```
*Note: Native modules (sqlite-vec) require a Development Build or Simulator, not Expo Go.*

### Prebuild (Regenerate Native Projects)
```bash
npx expo prebuild --clean
```
The `ios/` and `android/` folders are **ephemeral** - regenerated each time.

---

## Critical "Gotchas"

1. **Time Context:** Project launched January 2026. If this seems like the future, verify your system time.

2. **CNG-Only:** Agents should **NEVER** create or edit `plugins/`, `modules/`, `ios/`, or `android/` folders.

3. **Environment Variables:** `EXPO_PUBLIC_MAPBOX_TOKEN` is mandatory. Copy `.env.example` to `.env` and add your Mapbox keys before building.

4. **Python Tooling:** Always use `uv` for all Python operations in the conductor.

5. **Offline-First:** Prioritize offline-first architecture in all TypeScript code.

---

## Validation Checks Before Operations

Before running builds or deploys, verify:
```bash
# Check that keys exist and are not placeholders
if grep -q "your_token_here\|YOUR_TOKEN_HERE\|placeholder" .env; then
  echo "ERROR: .env contains placeholder values"
  exit 1
fi

# Check that required keys are present
if ! grep -q "^EXPO_PUBLIC_MAPBOX_TOKEN=pk\." .env; then
  echo "ERROR: Missing valid Mapbox public token"
  exit 1
fi
```

---

## When Another Agent Breaks .env

If you detect that another agent has replaced real keys with placeholders:

1. **STOP immediately** - Do not proceed with builds/operations
2. **Alert the user**: "The .env file has been corrupted. Real API keys were replaced with placeholders."
3. **Do NOT attempt to fix it yourself** - The user needs to restore from backup or keychain
4. **Check git history**: `git diff HEAD .env` to see what was changed

---

## Summary for Agents

**You are in a trusted local environment with full access. Real keys exist in `.env` - your job is to USE them, not REPLACE them.**

When in doubt: **Read, don't write** to `.env` files.
